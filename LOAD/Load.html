<!DOCTYPE html>
<html>

<head>
    <title>Hello World</title>
    <!-- Your external script -->
    <!-- python -m SimpleHTTPServer -->
    <script src="https://d3js.org/d3.v5.min.js"></script>

</head>

<body>
    <div id='p'></div>
</body>
<script type="text/javascript">

    let good_students = [1, 2, 3, 4, 8, 9, 10, 11, 12, 15, 18, 19, 20, 21, 21, 23, 24, 25, 26, 27, 30];
    let no_students = [13, 16, 29];
    let bad_students = [5, 6, 7, 14, 17, 28, 31];
    let topics;
    let s_in_c;
    let posts = [];
    let attemps = [];
    let submissions = [];
    let forums = [];
    let quizzes = [];
    let assigns = [];
    let beginDate = new Date(2020, 9, 20, 0, 0, 0, 0);
    d3.dsv(';', "input/topics.csv").then(function (data) {
        for (let index = 0; index < data.length; index++) {
            let element = data[index];
            element.start = Number(element.start);
            element.end = Number(element.end);
            element.course = Number(element.course);
            element.type = Number(element.type);
            element.id = index;
        }
        topics = data;
        d3.dsv(',', "input/s_in_c.csv").then(function (data) {
            data.forEach(function (d) {
                d.student = Number(d.student);
                d.course = Number(d.course);
            });
            s_in_c = data;
            for (let index = 0; index < topics.length; index++) {
                let topic = topics[index];
                let DAY = Math.random() * (topic.end - topic.start + 1) + topic.start;
                good_students.forEach(element => {
                        if (student_in_course(element, topic.course)) {
                            if (Math.random() > 0.3) {    
                   participate(element, topic, DAY);
                        }
                    }
                });
                bad_students.forEach(element => {
                    if (student_in_course(element, topic.course)) {
                        if (Math.random() > (Math.E ^( -25.0 / DAY))) {
                                participate(element, topic, DAY);
                            }
                        }
                    
                });

            }
            SeparedteTopics();
        });
    });
    function JSONtoCSV(data) {
        let res = Object.keys(data[0]).join() + '</br>';
        data.forEach(element => {
            res += Object.values(element).join() + '</br>';
        });
        return res;
    }
    function participate(student, topic, day) {
        switch (topic.type) {
            case 1:
                let post = {
                    student: student,
                    forum: topic.id,
                    datecreated: Math.floor(Math.floor(beginDate.getTime() + day * 1000 * 60 * 60 * 24) / 1000),
                    type: Math.floor(Math.random() * 2)
                };
                posts.push(post);
                break;
            case 3:
                let quiz = {
                    student: student,
                    quiz: topic.id,
                    start: Math.floor(Math.floor(beginDate.getTime() + day * 1000 * 60 * 60 * 24) / 1000)
                };
                attemps.push(quiz);
                break;
            case 4:
                let subm = {
                    student: student,
                    assign: topic.id,
                    created: Math.floor(Math.floor(beginDate.getTime() + day * 1000 * 60 * 60 * 24) / 1000)
                };
                submissions.push(subm);
                break;
            default:
                console.log("Other");
                break;
        }
    }
    function student_in_course(student, course) {
        for (let index = 0; index < s_in_c.length; index++) {
            const e = s_in_c[index];
            if (e.student == student && e.course == course) {
                return true;
            }
        }
        return false;
    }
    function getOpenTopics(topics, day) {
        let res = [];
        for (let index = 0; index < topics.length; index++) {
            const element = topics[index];
            if (element.start <= day && day <= element.end) {
                res.push(element);
            }
        }
        return res;
    }
    function WriteToPage(json) {
        let p = document.getElementById('p');
        p.innerHTML = JSONtoCSV(json);
    }
    function SeparedteTopics() {
        for (let index = 0; index < topics.length; index++) {
            const element = topics[index];
            switch (element.type) {
                case 1:
                    forums.push({ id: element.id, course: element.course , duedate: Math.floor(Math.floor(beginDate.getTime() + element.end * 1000 * 60 * 60 * 24) / 1000)});
                    break;
                case 3:
                    quizzes.push({ id: element.id, course: element.course, attemps: Math.floor(Math.random() * 1.05), time_open: Math.floor(Math.floor(beginDate.getTime() + element.start * 1000 * 60 * 60 * 24) / 1000),time_close: Math.floor(Math.floor(beginDate.getTime() + element.end * 1000 * 60 * 60 * 24) / 1000) });
                    break;
                case 4:
                    assigns.push({ id: element.id, course: element.course,time_open: Math.floor(Math.floor(beginDate.getTime() + element.start * 1000 * 60 * 60 * 24) / 1000), due: Math.floor(Math.floor(beginDate.getTime() + element.end * 1000 * 60 * 60 * 24) / 1000) });
                    break;
                default:
                    break;
            }
        }
    }
</script>
</html>